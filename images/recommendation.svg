flowchart TD
    subgraph "User Profile Input"
        direction TB
        USER[User Profile Data<br/>ðŸ‘¤ Complete Dataset]
        NAME[Name: String<br/>Personalization Key]
        INCOME[Income: Number<br/>â‚¹25,000 - â‚¹10,00,000]
        AGE[Age: Number<br/>21-65 years]
        CREDIT[Credit Score: Number<br/>300-900 range]
        BENEFITS[Benefits: String<br/>cashback/travel/rewards]
    end
    
    subgraph "Data Validation & Processing"
        direction TB
        VALIDATE{Data Complete?<br/>All 5 fields present}
        CLEAN[Data Cleaning<br/>Normalize & Sanitize]
        PROFILE[Build User Profile<br/>Structured Object]
    end
    
    subgraph "Card Database Filtering"
        direction TB
        LOAD[Load Card Database<br/>Supabase/Fallback Data]
        ELIGIBLE[Income Eligibility Filter<br/>card.min_income â‰¤ user.income]
        AVAILABLE[Available Cards Pool<br/>Eligible for Analysis]
    end
    
    subgraph "AI Scoring Algorithm"
        direction TB
        
        subgraph "Benefit Match Analysis (35 points)"
            BENEFIT_CHECK[Benefit Type Matching]
            CASHBACK[Cashback Match<br/>+35 points]
            TRAVEL[Travel/Miles Match<br/>+35 points]
            REWARDS[Rewards/Points Match<br/>+30 points]
            GENERIC[Generic Match<br/>+10 points]
        end
        
        subgraph "Reward Rate Scoring (25 points)"
            RATE_CALC[Calculate Reward Rate<br/>base_reward_rate * 4]
            HIGH_RATE[â‰¥5% Rate<br/>Exceptional Tier]
            MID_RATE[â‰¥2% Rate<br/>Competitive Tier]
            LOW_RATE[>0% Rate<br/>Standard Tier]
        end
        
        subgraph "Fee Value Analysis (20 points)"
            FEE_CHECK[Annual Fee Assessment]
            FREE_FEE[â‚¹0 Fee<br/>+20 points]
            LOW_FEE[â‰¤â‚¹500 Fee<br/>+17 points]
            MID_FEE[â‰¤â‚¹2000 Fee<br/>+12 points]
            HIGH_FEE[>â‚¹2000 Fee<br/>+3-8 points]
        end
        
        subgraph "Income Optimization (10 points)"
            INCOME_RATIO[Income to Min_Income Ratio]
            EXCELLENT[Ratio â‰¥3<br/>+10 points]
            GOOD[Ratio â‰¥1.5<br/>+8 points]
            MEETS[Ratio â‰¥1<br/>+5 points]
        end
        
        subgraph "Age Suitability (5 points)"
            AGE_CHECK[Age Range Analysis]
            OPTIMAL[25-50 years<br/>+5 points]
            ACCEPTABLE[Other ages<br/>+3 points]
        end
        
        subgraph "Credit Score Boost (5 points)"
            SCORE_CHECK[Credit Score Assessment]
            EXCELLENT_CREDIT[â‰¥750 Score<br/>+5 points]
            GOOD_CREDIT[â‰¥700 Score<br/>+4 points]
            FAIR_CREDIT[<700 Score<br/>+2 points]
        end
    end
    
    subgraph "Ranking & Selection"
        direction TB
        CALCULATE[Calculate Total Scores<br/>Sum all factors]
        SORT[Sort by Score<br/>Descending order]
        TOP3[Select Top 3 Cards<br/>Best matches]
        FALLBACK[Ensure 3 Cards<br/>Add alternatives if needed]
    end
    
    subgraph "Recommendation Generation"
        direction TB
        INTRO[Generate Intro Message<br/>Personalized with user data]
        CARD1[ðŸ¥‡ Top Recommendation<br/>Highest scored card + reasons]
        CARD2[ðŸ¥ˆ Alternative Option<br/>Second best + reasons]
        CARD3[ðŸ¥‰ Additional Choice<br/>Third option + reasons]
        SUMMARY[Comprehensive Summary<br/>Analysis breakdown]
    end
    
    subgraph "Real-time Output"
        direction TB
        WIDGETS[Interactive Card Widgets<br/>Apply buttons + details]
        REASONS[Match Reasons<br/>Personalized explanations]
        SCORES[Match Scores<br/>Percentage ratings]
        ACTIONS[Action Buttons<br/>Apply/Compare/Details]
    end
    
    %% Main Flow
    USER --> VALIDATE
    NAME --> VALIDATE
    INCOME --> VALIDATE
    AGE --> VALIDATE
    CREDIT --> VALIDATE
    BENEFITS --> VALIDATE
    
    VALIDATE -->|Yes| CLEAN
    VALIDATE -->|No| ERROR[Missing Data Error<br/>Request complete info]
    ERROR --> USER
    
    CLEAN --> PROFILE
    PROFILE --> LOAD
    LOAD --> ELIGIBLE
    ELIGIBLE --> AVAILABLE
    
    AVAILABLE --> BENEFIT_CHECK
    BENEFIT_CHECK --> CASHBACK
    BENEFIT_CHECK --> TRAVEL
    BENEFIT_CHECK --> REWARDS
    BENEFIT_CHECK --> GENERIC
    
    AVAILABLE --> RATE_CALC
    RATE_CALC --> HIGH_RATE
    RATE_CALC --> MID_RATE
    RATE_CALC --> LOW_RATE
    
    AVAILABLE --> FEE_CHECK
    FEE_CHECK --> FREE_FEE
    FEE_CHECK --> LOW_FEE
    FEE_CHECK --> MID_FEE
    FEE_CHECK --> HIGH_FEE
    
    AVAILABLE --> INCOME_RATIO
    INCOME_RATIO --> EXCELLENT
    INCOME_RATIO --> GOOD
    INCOME_RATIO --> MEETS
    
    AVAILABLE --> AGE_CHECK
    AGE_CHECK --> OPTIMAL
    AGE_CHECK --> ACCEPTABLE
    
    AVAILABLE --> SCORE_CHECK
    SCORE_CHECK --> EXCELLENT_CREDIT
    SCORE_CHECK --> GOOD_CREDIT
    SCORE_CHECK --> FAIR_CREDIT
    
    %% Scoring flows to calculation
    CASHBACK --> CALCULATE
    TRAVEL --> CALCULATE
    REWARDS --> CALCULATE
    GENERIC --> CALCULATE
    HIGH_RATE --> CALCULATE
    MID_RATE --> CALCULATE
    LOW_RATE --> CALCULATE
    FREE_FEE --> CALCULATE
    LOW_FEE --> CALCULATE
    MID_FEE --> CALCULATE
    HIGH_FEE --> CALCULATE
    EXCELLENT --> CALCULATE
    GOOD --> CALCULATE
    MEETS --> CALCULATE
    OPTIMAL --> CALCULATE
    ACCEPTABLE --> CALCULATE
    EXCELLENT_CREDIT --> CALCULATE
    GOOD_CREDIT --> CALCULATE
    FAIR_CREDIT --> CALCULATE
    
    CALCULATE --> SORT
    SORT --> TOP3
    TOP3 --> FALLBACK
    FALLBACK --> INTRO
    
    INTRO --> CARD1
    CARD1 --> CARD2
    CARD2 --> CARD3
    CARD3 --> SUMMARY
    
    SUMMARY --> WIDGETS
    WIDGETS --> REASONS
    REASONS --> SCORES
    SCORES --> ACTIONS
    
    %% Error handling
    AVAILABLE -.->|No cards| NO_CARDS[No Eligible Cards<br/>Adjust criteria]
    NO_CARDS -.-> ERROR
    
    %% Performance optimization
    LOAD -.->|Cache hit| CACHE[Use Cached Data<br/>Faster processing]
    CACHE -.-> ELIGIBLE
    
    %% Styling
    classDef inputNode fill:#e1f5fe,stroke:#01579b,stroke-width:2px,color:#000
    classDef processNode fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef scoringNode fill:#fff3e0,stroke:#e65100,stroke-width:2px,color:#000
    classDef resultNode fill:#f3e5f5,stroke:#4a148c,stroke-width:2px,color:#000
    classDef errorNode fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000
    classDef cacheNode fill:#f1f8e9,stroke:#558b2f,stroke-width:2px,color:#000
    
    class USER,NAME,INCOME,AGE,CREDIT,BENEFITS inputNode
    class VALIDATE,CLEAN,PROFILE,LOAD,ELIGIBLE,AVAILABLE,CALCULATE,SORT,TOP3,FALLBACK processNode
    class BENEFIT_CHECK,CASHBACK,TRAVEL,REWARDS,GENERIC,RATE_CALC,HIGH_RATE,MID_RATE,LOW_RATE,FEE_CHECK,FREE_FEE,LOW_FEE,MID_FEE,HIGH_FEE,INCOME_RATIO,EXCELLENT,GOOD,MEETS,AGE_CHECK,OPTIMAL,ACCEPTABLE,SCORE_CHECK,EXCELLENT_CREDIT,GOOD_CREDIT,FAIR_CREDIT scoringNode
    class INTRO,CARD1,CARD2,CARD3,SUMMARY,WIDGETS,REASONS,SCORES,ACTIONS resultNode
    class ERROR,NO_CARDS errorNode
    class CACHE cacheNode